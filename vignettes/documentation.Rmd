---
title: "Predicting birds' flight range"
author: "Brian Masinde"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    highlight: tango
    citation_package: natbib
  html_document:
    standalone: true
    self-contained: true
vignette: >
  %\VignetteIndexEntry{documentation}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
bibliography: references.bib
always_allow_html: yes
---
```{r packs, echo=FALSE, eval = FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(knitr)
library(kableExtra)
library(dplyr)
#library(captioner)
library(flying)
```


# Introduction
Flight is a computer program that accompanies @penny08 which in detail discusses
the theory behind bird flight. However, there are two drawbacks with the program.
First, it is only available for Windows OS, and second, it requires manual imputation
of bird measurements which is a tedious process when one has thousands of birds to 
analyse. Thus, the aim of this project is to implement in R, range estimation methods.
R runs on all major operating system and the package is able to read files
from a path, with multiple bird samples.

The theory behind flight mechanism has evolved over time. @penny75 used Breguet equations
intended for range estimation in fixed wing aircraft. Later ornithologists had 
hypotheses that in long-distance bird migration a more complex process occurs. 
And these were confirmed by field study where samples of birds were weighed before
migration and after migration. Wind tunnel studies were also done to determine
the aerodynamics of birds, that is, the body components that contribute to lift and drag.
Considering the tremendous distances covered by migrating birds, at great cost,
this branch of ornithology is more concerned with the mechanical and chemical
process involved during migration.

## Migration
Bird migration is influenced by seasonal patterns, primarily for food and 
breeding. Studying bird migration takes more into account than general flight. 
The distance covered during migration varies widely between species, and 
therefore it is of interest to understand physiological components that explain 
differences in range. Estimation of flight range in migrating birds aids in 
estimating flight time therefore number of stops for feeding and resting before 
final destination (hot-spots). In ornithology, flight range is important because
it gives insight into fuel consumption, energy requirements, feeding habits, 
resting time duration. While this can be achieved by geo-tagging birds before 
migration, it is neither possible for all species (example in the case of extinct
species or rare bird species) nor economical. In addition, a good number will be
victims of predation, diseases, weather and collisions. What are the consequences
if birds have to migrate longer distances due to interference with hot-spots, 
either due to human activity or climate change.

# Methods
## Mechanics of Flight
Mechanics of flight in birds requires more than a set of wings. For example 
penguins have wings but yet they do not fly. @penny08 using Flight program shows 
that for a penguin to fly it requires a wing beat frequency equivalent to a 
hummingbird's. The wing beat frequency is proportional to the all-up body mass, 
wing span, wing area, acceleration due to gravity and air density. Therefore, in
the penguin example, this implies comparing these physical characteristics 
between penguins and hummingbirds (gravity and air density as constants). 

@penny75 determined that five bird body measurements are necessary in estimating
the flight range of birds. These are:

*   __All up mass__: The body mass (Kg.) including contents of the crop, 
fuel (fat mass), and any other equipment the bird has to carry for the duration 
of the flight.

*   __Wing span__: In meters measured from tip to tip of the fully outstretched 
wings.

*   __Fat mass__: Mass of fat that is consumable as fuel.

*   __Order__: The taxon the bird belongs to (asserine vs non-passerine). These
two taxons in theory have different metabolism rates. 

*   __Wing area__: Area of both wings projected on a flat surface, including the 
body part in-between the wings.


## Outline method 1 based on Brequet equations.
This method is intended for passerines with body mass less than 50 grams. Below is
a list of constants (variable definition within the package).

*  Profile power constant (ppc = 8.4). This can also be adjusted.

*  Energy content of fuel per kg $e$ (eFat = 4 * 10 ^ 7)

*  Acceleration due to gravity $g$ (g =  9.81)

*  Mechanical conversion efficiency $\eta$ (mce= 0.23).

*  Induced power factor $k$ (ipf= 1.20)

*  Ventilation and circulation power $R$ (R = 1.10)

*  Air density at flight height $\rho$. This can be changed
according to altitude the bird species is known to fly (default airDensity = 1.00). 

*  Body drag coefficient $C_Db$(bdc = 0.10)

*  Basal metabolic rate $\Pi_m$ empirical constants

    *  alpha passerines = 6.25, alpha non-passerines = 3.79
    
    *  delta passerines = 0.724, delta non-passerines = 0.723
    


* Step1:
With all-up mass and fat mass defined, the first step is to derive the fuel ratio.

$$
 fuel \ ratio = \frac{fat \ mass}{all-up \ mass}
$$

Next calculate *profile power ratio* alternative to defining it as 1.20 for each bird as was the case in the initially for these models. Instead the profile power constant is used to derive the profile power ratio. In this case the equation below provides a better individual estimate.

$$
 X_1 = \frac{C_{pro}}{R_a}
$$

Where the $profile \ power \ constant = 8.4$
$$
R_a = \frac{B^2}{wing \ area}
$$

The box-plot below shows the distribution of profile power ratio of the preset birds.

```{r X1, echo=FALSE, fig.height=5, fig.width=6}
#load("~/Documents/R projects/Flight project/flying/data/birds.rda")
data("birds", package = "flying")
prof.pow.ratio <- function(ws, wa, cons) {
  # ws = wing span
  # wa = wing area
  X1 <- cons$ppcons / (ws ^ 2 / wa)

  return(X1)
}

cons <- list(
    # profile power constant
    ppcons = 8.4,

    # eneryg content of fuel per kg
    energy = 4 * 10 ^ 7,

    # accelaration due to gravity
    g = 9.81,
    # mechanical efficiency  [0,1]
    n = 0.23,

    # induced power factor
    k = 1.20,

    # ventilation and circulation power (Tucker's data)
    R =  1.10,

    # air density at fligh height
    airDensity = 1.00,

    # body drag coefficient
    bdc = 0.10,

    # constant varies btw passerines and non-passerines
    alpha = c(6.25, 3.79),
    delta = c(0.724, 0.723)
  )

boxplot(prof.pow.ratio(birds$Wing.span, birds$Wing.area, cons),
        main = "Profile power distribution among preset birds",
        col = "#58CCED")
```

In Pennycuik's earlier version, a table is provided for interpolation of metabolic power ratio based on body mass (at start of flight) and the wing span. However, in this implementation, the metabolic power ratio is calculated using the formulas provided in the book. Theory states that metabolic power is required through out irrespective of what the bird is doing.

$$
X2 = \frac{6.03 \ \alpha \ \eta \ \rho^{0.5} \ B^{3/2} M ^{\delta - 5/3}}{k^{3/4}g^{5/3}}
$$

Where $\alpha \ \text{and} \ \delta$ are constants from basal metabolism (see equation below), $\rho$ as air density,  $B$ as wing span, and $M$ as body mass.

*  Basal metabolism for passerines:

$$
  \Pi _m = \alpha M^{\delta} \\
  \alpha = 6.25 \\
  \delta = 0.724
$$

*  Basal metabolism for non-passerines:

$$
  \Pi _m = \alpha M^{\delta} \\
  \alpha = 3.79 \\
  \delta = 0.723
$$

With both metabolism power ratio and profile power ration defined, enables interpolation of the drag (D) from the table below.

```{r factor_table2, echo=FALSE}
gen.table2 <- function() {
  x1Plusx2 <- c(0.00, 0.25, 0.50, 0.75, 1.00, 1.25, 1.50, 1.75, 2.00,
                2.25, 2.50, 2.75, 3.00, 3.25, 3.50, 3.75, 4.00, 4.25,
                4.50, 4.75, 5.00)
  B <- c(1.360, 1.386, 1.452, 1.515, 1.574, 1.631, 1.684, 1.735, 1.784, 1.830,
         1.875, 1.918, 1.959, 1.999, 2.038, 2.075, 2.111, 2.146, 2.180, 2.213,
         2.246)
  C <- c(1.140, 1.458, 1.783, 2.115, 2.453, 2.795, 3.141, 3.490, 3.841, 4.195,
         4.550, 4.907, 5.266, 5.625, 5.986, 6.348, 6.711, 7.074, 7.438,
         7.803, 8.168)
  D <- c(1.000, 0.824, 0.706, 0.621, 0.556, 0.506, 0.465, 0.431, 0.402, 0.378,
         0.357, 0.339, 0.322, 0.308, 0.295, 0.283, 0.273, 0.263, 0.254, 0.246,
         0.238)
  table2 <- as.data.frame(cbind(x1Plusx2, B, C, D))

  return(table2)
}

table1 <- knitr::kable(gen.table2(), label = "Table 1", caption = "Factor Table")

kableExtra::kable_styling(table1, latex_options = "HOLD_position")

```

```{r}
gen.table2()
```

In calculating the lift:drag ratio, the disk and equivalent flat-plate areas of a bird are important. The disc area ($S_d$) is the area of complete circle under which the wing span is the diameter, while the equivalent flat-plate area is a product of the frontal area and drag coefficient of a bird.

$$
  S_d = \frac{\pi B^2}{4}
$$

$$
  A = S_bC_{Db} \\
  S_b = 0.00813m^{0.666} \\
  C_{Db} = 0.1
$$

*Note that there is a difference here between the two books.* In the earlier version the equivalent flat-plate area is defined as:

$$
  A = (2.85 \times 10^{-3})M^{2/3}
$$

Next step calculate effective lift:drag ratio from the formula:

$$
  \bigg( \frac{L}{D}\bigg)' = \frac{D}{k^{0.5}R} \bigg( \frac{S_d}{A}\bigg)^{0.5}
$$

This method corrects for change in effective lift:drag ratio during flight by increasing the lift:drag ratio by $10 \times F$ expressed as a percentage.


Finally, the range (in meters) is estimated using:

$$
  Y = \frac{e \eta}{g} \bigg( \frac{L}{D}\bigg)' ln \frac{1}{1 - F}
$$

## Outline method 2 based on Brequet equations.

Method is only appropriate for __non-passerines__ and or birds with 
$body mass > 50 \ g$ , lift:drag ratio is calculated at the beginning and at the
end of the flight. Lift:drag ratio at the start of flight is calculated using 
the all-up mass at start, while at end of flight the mass of fuel to be used 
during the flight it is subtracted from the all up mass. In the function, user 
can specify percentage of fuel mass to be used during mass. This method, uses 
the constants defined in method 1. 

*Step 1*
Fat fraction is computed as before (as a ratio of fat mass and all-up body mass). 

*Step 2*
An estimate of the body mass at end of flight is attained by subtracting fuel 
mass to be consumed during flight from the all-up body mass.

*Step 3*
Calculate *metabolic power ratio* but this time using body mass at end of flight.

$$
X2_{end} = \frac{6.03 \ \alpha \ \eta \ \rho^{0.5} \ B^{3/2} M_2 ^{\delta - 5/3}}{k^{3/4}g^{5/3}} \\
\\
\text{where } M_2 = \ \text{body mass at end of flight}    
$$

*Profile power constant* calculation remains the same as in method 1.

$$
 X_1 = \frac{C_{pro}}{R_a}
$$

*Step 4*
To find drag at end of flight, metabolic power ratio and the profile power constant are summed and interpolation is done on *table 1* as defined in Pennycuick.

*Step 5*
Disk area and flat plate area are components that contribute to lift. While disk area is independent of body mass, flat-plate area is not. Therefore, flat-plate area is computed using body mass at end of flight.

$$
  S_d = \frac{\pi B^2}{4}
$$

$$
A_{end} = S_bC_{Db} \\
  S_b = 0.00813 \times \ m_2^{0.666} \\
  C_{Db} = 0.1
$$

Where $m_2$ is body mass at end of flight.

*Step 6*
Proceed to calculate effective lift:drag ratio at end of flight.

$$
\bigg( \frac{L}{D}\bigg)'_{end} = \frac{D_{end}}{k^{0.5}R} \bigg( \frac{S_d}{A_{end}}\bigg)^{0.5}
$$

*Step 7*
To avoid repetition, Pennycuick demonstrates how to estimate metabolic power constant at start by dividing the estimate at end of flight by some factor.

$$
X2_{start} = \frac{X2_{end}}{\bigg(\frac{1}{1 - F}\bigg)^{7/4}}
$$

Followed by interpolation on *table 1* to get drag at start of flight.

*Step 8*
Get square root of ratio between disk area and flat-plate area at beginning of flight as:

$$
\bigg(\frac{S_d}{A}\bigg)^{0.5}_{start} = \frac{\bigg(\frac{S_d}{A}\bigg)^{0.5}_{end}}{\bigg(\frac{M_1}{M_2} \bigg)^{0.5}}
$$


Where $M_1$ and $M_2$ are all-up mass at beginning and body mass at end of 
flight respectively.


*Step 9*
Calculate lift:drag ratio using the start of flight estimates then get the 
average of the two lift:drag ratio.

*Step 10*
Get range using the mean of the lift:drag ratio.

$$
 Y = \frac{e \eta}{g} \bigg( \frac{L}{D}\bigg)'_{avg} ln \frac{1}{1 - F}
$$

## Time-marching computation
Breguet equations assume that lift:drag ratio remains constant through out the flight. This is appropriate for fixed wing aircraft. However, birds are known to consume part of the engine (use protein in flight muscles and air-frame as supplementary fuel). This leads to an increase in lift:drag ratio during the flight as result of the reduce in body mass and thus, an increase in flight range [@penny03]. In the methods discussed above, compensation for this is done by adding 10% of fuel to the lift:drag ratio (method 1) or averaging lift:drag ratio before start of flight and at the end of flight (method 2). @penny03 cites studies which found that protein is replenished faster during short stop-overs compared to fat mass. Furthermore, the constant ($e$) cannot be assumed to be constant because of two different sources of fuel. Protein and fat have different energy content.

Other than derive equations via ODE, @penny98 found it more useful to use the 
time-marching computation. This simulation assumes that mechanical and chemical 
powers of a bird are held constant for a short duration during flight (usually 6
minutes), fat and muscle mass are deducted by any one of the three criteria:

* Constant specific work

* Constant specific power

* Constant muscle mass

@penny03 describes time-marching as calculating amounts of fat and protein consumed
during a short period (6 minutes) during which all variables including power and
speed are assumed constant. After every 6 minute interval, the birds mass composition 
is revised taking into account the small changes in fat and protein consumed 
during the interval. In Flight program this is repeated until the required distance
it achieved or it runs out of fat mass. This procedure places no restriction
on speed. @penny03 points out that the remaining fat and mass at the end of the 
flight can be compared with field observations. 

The scope of this project involves implementing the time-marching simulation with
the constant muscle mass criterion.

### Constant Muscle Mass criterion.
Time-marching simulations really on the speed, total mechanical power, and the 
chemical power.

#### Speed
The minimum power speed is central in time-marching computation. This is estimated
analytically using the formula. Notice it dependent on the air density, and all-up
body mass

$$
  V_{mp} = \frac{0.807k^{1/4} m ^{1/2}g^{1/2}}{\rho^{1/2} B^{1/2} S_{b}^{1/4}C_{Db}^{1/4}}
$$

$$
  V_t = 1.2 \times V_{mp}
$$

#### Total mechanical power
The total mechanical is a sum of three powers:

* __Parasite power__: The rate at which power must be done to overcome drag of body [@penny08].
For any streamlined body the drag is expressed as:

$$
D_b = \frac{\rho V_t^2 S_b C_{Db}}{2}
$$
And parasite power is found by multiplying the drag by the true airspeed $V_t$:

$$
P_{par} = \frac{\rho V_t^3 S_b C_{Db}}{2}
$$

where $\rho$ is the air density, $V_t$ is the true airspeed, $S_b$ is the frontal 
area of the body and $C_{Db}$ is the body drag coefficient.

* __Profile power__
This is power needed to over the effects of the body drag. And this is a multiple
of _profile power ratio_ (X1) and the absolute minimum power $P_{am}$:

$$
  P_{pro} = X1 \times P_{am}
$$

$$
P_{am} = \frac{(1.05 k ^{3/4} m^{3/2} g^{3/2} S_b^{1/4} C_{Db}^{1/4})}{(\rho^{1/2}B^{3/2})}
$$
and $X_1$:

$$
  X_1 = \frac{C_{pro}}{R_a}
$$

* __Induced power__
Power required to support a birds wight during forward flight.

$$
  P_{ind} = \frac{(mg^2)}{2V_{t}Sd\rho}
$$

The total mechanical power is found by summing the profile power, parasite power
and induced power. Parasite power and induced power are depend on the true airspeed
during flight. 

$$
P_{mech} = P_{pro} + P_{par} + P_{ind}
$$

#### Chemical power
@penny08 remarks that mechanical power is derived from measurements made in unaccelerated
flight (i.e from forces and speeds that do not involve physiology), however, the chemical power
is derived using measurements from physiological experiments. These measurements include:

* Rates of consumption of fuel

* Rate of consumption of oxygen

* Metabolism rate

It is only useful to estimate this in long aerobic flight [@penny08].

To estimate the chemical power during a flight interval, the mechanical power is
first estimated (power required from muscles to support the weight against gravity
). Then the mechanical power is divided by the mechanical conversion efficiency. A
value between 0 and 1, in Flight the default is 0.23. The basal metabolism rate is
added because metabolism is a body function that occurs irrespective of what the bird 
is doing. Estimate derived so far is increased by $10\%$ to account for heart and lungs.
This chemical power expresses the total energy required by a bird to sustain flight.

#### Range Estimation Constant Muscle Mass Criterion 
So assembling this mechanism to estimate the flight range, first true airspeed is 
estimated and used to calculate the total mechanical power, Total mechanical power
is converted to chemical power then divided by the energy content of fat (since fat
is the only source of fuel in this scenario). Multiplying thhis by the calculation interval
(default 6 minutes or 360 seconds) gives the range achieved during this interval
in m/s. It was noted that decreasing the flight interval has no effect on range
only that the estimation of the processes is more fine grained. This procedure is iterated
over until fat mass decreases to zero. In Flight there is an option to attribute
a small percentage of the chemical power to protein from the muscle mass, usually
$5\%$

### Protein withdrawal criterion.
@penny03 find that holding specific work constant is most realistic criteria for
determining how  much fuel and protein to be withdrawn during 6 minute intervals
of flight. Specific work is defined in as work done by unit mass of contractile
tissue muscle. Further, @penny03, states that flight muscles contain myofibrils 
and mitochondria, which are treated separately in the simulation. To be exact enough
mass of myofibrils is reduced by an amount sufficient to restore specific work
to the value it had at beginning of flight. In addition, fuel energy corresponding
to mass of dry protein consumed is deducted from energy that would otherwise
come from fuel/fat consumption.
Also, initial climb, and all other flight styles other than continuous wing flapping are not accounted for. 


# Results comparison.
Note that it is not fair comparison between the methods discused in @penny75
and the methods in @penny08 and therefore the tables with range estimations are presented
separately. Default constants were used for all the observations. Most importantly
the air density was set to 1.00 which is about 2000 metres above sea level.

## The Data
Data used as an example, is from the program _Flight_ for windows [@penny08] version
1.2.5.2. For some observations the fat mass and muscle mass were set to zero, maybe
for lack of data since these variables cannot be measured directly compared to 
the all-up mass and wing span. Flight requires that fat mass is defined to calculate
range since it is the main source of fuel. To overcome this, fat mass was randomly 
generated between $18\%$ and about $35\%$ of the all-up mass (empty mass because crop is empty).
For muscle mass, by defualt, Flight uses the muscle fraction 0.17, and therefor this was used to derive the muscle mass.

$$
 muscle \ fraction = \frac{muscle \ mass}{all-up \ mass}
$$

```{r data, echo = FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
data("birds")
table2 <- knitr::kable(birds, caption = "Preset birds from Flight program")
kableExtra::kable_styling(table2, latex_options = "HOLD_position")
```

## Results based on @penny75
```{r}
results_fixed_wing <- flysim(data = birds) 

# range 
results_fixed_wing$range
```

```{r}
# constants used
results_fixed_wing$constants
```


## Time-marching: Constant Muscle Mass
In the simulation in Flight program, air density was set to 1 (Altitude 2063 
meters above sea-level), muscle was held constant (Protein burn criterion), 
fat energy at $3.9E+07$, continuous flapping style (Flight style), and minimum
energy from protein at $0\%$ instead of the defualt $5\%$. Induced power factor
is set to 1.20 for all birds. The mitochondrial fraction is set to hold constant.

Flight provides two methods of speed control, true air-speed to minimum power 
speed is held constant or true air-speed is held constant. Both of these scenarios are compared to the output of this package below:


```{r}
# constant speed
results_cmm_cs <- migrate(data = birds, speed_control = "constant_speed")

results_cmm_cs$range
```


```{r}
# constant ratio between true air-speed and minimum power speed
results_cmm_cratio <- migrate(data = birds, speed_control = "vvmp_constant")

results_cmm_cratio$range
```

```{r tables, echo=FALSE}
# results simulated from flight true air-speed constant
flight_cons_speed <- c(3090, 2670, 3702, 1115, 3821, 3519, 11418, 3383, 2922,
                            NA ,2248, 1867, 2031, 5186, 9880, 5308, 5498, 2606, 
                            6439, 5776, NA, NA, 2385, 2221, 2684, 5658, 5071, 6427)
flight_cons_ratio <- c(3007, 2586, 3566, 1076, 3679, 3417, 10647, 3267, 2789,
                       3016, 2146, 1798, 1975, 4946, 9499, 5120, 5378, 2541, 
                       6140, 5544, NA, 3374, 2275, 2119, 2571, 5381, 4871, 6153
                       )

results_table1 <- as.data.frame(results_cmm_cs$range)

results_table1$flight_results <- flight_cons_speed


results_table2 <-  as.data.frame(results_cmm_cratio$range)
results_table2$fight_results <- flight_cons_ratio  

colnames(results_table1) <-  c("package_cons_speed", "flight_cons_speed")

colnames(results_table2) <- c("package_cons_ratio","flight_cons_ratio")

```


```{r table1, echo=FALSE}
table3 <- knitr::kable(results_table1, label = "Table 2", caption = "Comparison table constant speed")
kableExtra::kable_styling(table3, latex_options = "HOLD_position")
```


```{r table2, echo=FALSE}
table4 <- knitr::kable(results_table2, label = "Table 3", caption = "Comparison table constant speed ratio")
kableExtra::kable_styling(table4, latex_options = "HOLD_position")
```

# Future work
In this section, aim is to discuss the evolution path of the package so that it 
incorporates as many features from Flight program as possible.
## Protein withdrawal criterion
@penny03 find that holding specific work constant is most realistic criteria for
determining how  much fuel and protein to be withdrawn during 6 minute intervals
of flight. This is in comparison with field observations. Specific work is defined
in as work done by unit mass of contractile tissue muscle. Further, @penny03, states
that flight muscles contain myofibrils and mitochondria, which are treated separately
in the simulation. To be exact enough mass of myofibrils is reduced by an amount
sufficient to restore specific work to the value it had at beginning of flight. 
In addition, fuel energy corresponding to mass of dry protein consumed is deducted
from energy that would otherwise come from fuel/fat consumption.

Holding the specific power constant is a third option in Flight program. In this
scenario, just enough protein from muscle mass is used to maintain the specific
power estimated at beginning of flight.

## Supplemtary protein from air-frame
In Flight program user has an option to specify minimum percentage of energy that
should come from protein. It is possible that muscle mass alone would not be able
sustain this, and therefore some of the protein can come from the air-frame.

## Initial climb
Initial climb, calculates the power required by the bird at start of flight. It
is possible that a bird maybe to heavy to fly under some conditions. In Table 3 and 
4 there were such cases.

# References
