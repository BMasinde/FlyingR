---
title: "Range Estimation in Migratory Birds"
output: rmarkdown::html_vignette
author: Brian Masinde
vignette: >
  %\VignetteIndexEntry{documentation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: references.bib
---
```{r packs, echo=FALSE, eval = FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(knitr)
library(kableExtra)
library(dplyr)
library(captioner)
```

```{r tbs, echo=FALSE}
# table references
table_nums <- captioner::captioner(prefix = "Table", levels = 1)

tab.1_cap <- table_nums(name = "tab_1", 
                        caption = "Usefull constants")
tab.2_cap <- table_nums(name = "tab_2", 
                        caption = "German Bundesliga: Final Table 2015/16, Position 12-18")

```


# Introduction

## Mechanics of Flight
Mechanics of flight in birds requires more than a set of wings. For example 
penguins have wings but yet they do not fly. @penny08 using Flight program shows 
that for a penguin to fly it requires a wingbeat frequency equivalent to a 
hummingbird's. The wingbeat frequency is proportional to the all-up body mass, 
wing span, wing area, accelaration due to gravity and air density. Therefore, in
the penguin example, this implies comparing these physiological variables 
between penguins and hummingbirds (gravity and air density as constants). 

@penny75 determined that five variables are necessary in estimating the flight 
range of birds. These are:

*   __All up mass__: The body mass (Kg.) including contents of the crop, 
fuel (fat mass), and any other equipment the bird has to carry for the duration 
of the flight.

*   __Wing span__: In meters measured from tip to tip of the fully outstretched 
wings.

*   __Fat mass__: Mass of fat that is consumable as fuel.

*   __Order__: Passerine vs non-passerine.

*   __Wing area__: Area of both wings projected on a flat surface, including the 
body part in-between the wings.

## Migration
Bird migration is influenced by seasonal patterns, primarily for food and 
breeding. Studying bird migration takes more into account than general flight. 
The distance covered during migration varies widely between species, and 
therofore it is of interest to understand physiological components that explain 
differences in range. Estimation of flight range in migrating birds aids in 
estimating flight time therefore number of stops for feeding and resting before 
final destination (hot-spots). In ornithology, flight range is important because
it gives insight into fuel consumption, energy requirements, feeding habits, 
resting time duration. While this can be achieved by geo-tagging birds before 
migration, it is neither possible for all species (example in the case of extinct
species or rare bird species) nor economical. In addition, a good number will be
victims of predation, diseases, weather and collisions. What are the consequences
if birds have to migrate longer distances due to interference with hot-spots, 
either due to human activity or climate change.

## Outline method 1 based on Brequet equations.
This method is intended for passerines with body mass less than 50 grams. In the 
included _birds_ data set, these are:


Defined constants:

*  Profile power constant (ppcons = 8.4). This can also be adjusted.

*  Energy content of fuel per kg (energy = 4 * 10 ^ 7)

*  Acceleration due to gravity (g =  9.81)

*  Conversion efficiency (n= 0.23).

*  Induced power factor (k= 1.20)

*  Ventilation and circulation power (R = 1.10)

*  Air density at flight height (default air_dens = 1.00). This can be changed at will.

*  Body drag coefficient (bdc = 0.10)

*  Basal metabolic rate (power) empirical constants

    *  alpha passerines = 6.25, alpha non-passerines = 3.79
    
    *  delta passerines = 0.724, delta non-passerines = 0.723
    


* Step1:
With all-up mass and fat mass defined, the first step is to derive the fuel ratio.

$$
 fuel \ ratio = \frac{fat \ mass}{all-up \ mass}
$$

Next calculate *profile power ratio* alternative to defining it as 1.20 for each bird. In this case the equation below provides a better individual estimate to the profile power ratio. (*Function: .prof_pow_ratio()*).

$$
X1 = \frac{profile \ power \ constant}{Aspect \ ratio}
$$

Where the $profile \ power \ constant = 8.4$
$$
Aspect \ ratio = \frac{wing \ span^2}{wing \ area}
$$

The box-plot below shows the distribution of profile power ratio of the preset birds.

```{r X1, echo=FALSE, fig.height=5, fig.width=6}
#load("~/Documents/R projects/Flight project/flying/data/birds.rda")
data("birds", package = "flying")
prof.pow.ratio <- function(ws, wa, cons) {
  # ws = wing span
  # wa = wing area
  X1 <- cons$ppcons / (ws ^ 2 / wa)

  return(X1)
}

cons <- list(
    # profile power constant
    ppcons = 8.4,

    # eneryg content of fuel per kg
    energy = 4 * 10 ^ 7,

    # accelaration due to gravity
    g = 9.81,
    # mechanical efficiency  [0,1]
    n = 0.23,

    # induced power factor
    k = 1.20,

    # ventilation and circulation power (Tucker's data)
    R =  1.10,

    # air density at fligh height
    airDensity = 1.00,

    # body drag coefficient
    bdc = 0.10,

    # constant varies btw passerines and non-passerines
    alpha = c(6.25, 3.79),
    delta = c(0.724, 0.723)
  )

boxplot(prof.pow.ratio(birds$Wing.span, birds$Wing.area, cons),
        main = "Profile power distribution among preset birds",
        col = "#58CCED")
```

In Pennycuik's earlier version, a table is provided for interpolation of metabolic power ratio based on body mass (at start of flight) and the wing span. However, in this implementation, the metabolic power ratio is calculated using the formulas provided in the book. (*Funciton: .met_pow_ratio()*).

$$
X2 = \frac{6.03 \ \alpha \ \eta \ \rho^{0.5} \ b^{3/2} M ^{\delta - 5/3}}{k^{3/4}g^{5/3}}
$$

Where $\alpha \ \text{and} \ \delta$ are constants from basal metabolism (see equation below), $\rho$ as air density,  b as wing span, and M as body mass.

*  Basal metabolism for passerines:

$$
  \Pi _m = \alpha M^{\delta} \\
  \alpha = 6.25 \\
  \delta = 0.724
$$

*  Basal metabolism for non-passerines:

$$
  \Pi _m = \alpha M^{\delta} \\
  \alpha = 3.79 \\
  \delta = 0.723
$$

With both metabolism power ratio and profile power ration defined, enables interpolation of the drag (D) from the table below.

`r table_nums('tab_1')`
```{r table2, echo=FALSE, fig.cap=tab.1_cap}
gen.table2 <- function() {
  x1Plusx2 <- c(0.00, 0.25, 0.50, 0.75, 1.00, 1.25, 1.50, 1.75, 2.00,
                2.25, 2.50, 2.75, 3.00, 3.25, 3.50, 3.75, 4.00, 4.25,
                4.50, 4.75, 5.00)
  B <- c(1.360, 1.386, 1.452, 1.515, 1.574, 1.631, 1.684, 1.735, 1.784, 1.830,
         1.875, 1.918, 1.959, 1.999, 2.038, 2.075, 2.111, 2.146, 2.180, 2.213,
         2.246)
  C <- c(1.140, 1.458, 1.783, 2.115, 2.453, 2.795, 3.141, 3.490, 3.841, 4.195,
         4.550, 4.907, 5.266, 5.625, 5.986, 6.348, 6.711, 7.074, 7.438,
         7.803, 8.168)
  D <- c(1.000, 0.824, 0.706, 0.621, 0.556, 0.506, 0.465, 0.431, 0.402, 0.378,
         0.357, 0.339, 0.322, 0.308, 0.295, 0.283, 0.273, 0.263, 0.254, 0.246,
         0.238)
  table2 <- as.data.frame(cbind(x1Plusx2, B, C, D))

  return(table2)
}

knitr::kable(gen.table2())

```

In calculating the lift:drag ratio, the disk and equivalent flat-plate areas of a bird are important. The disc area ($S_d$) is the area of complete circle under which the wing span is the diameter, while the equivalent flat-plate area is a product of the frontal area and drag coefficient of a bird.

$$
  S_d = \frac{\pi B^2}{4}
$$

$$
  A = S_bC_{Db} \\
  S_b = 0.00813m^{0.666} \\
  C_{Db} = 0.1
$$

*Note that there is a difference here between the two books.* In the earlier version the equivalent flat-plate area is defined as:

$$
  A = (2.85 \times 10^{-3})M^{2/3}
$$

Next step calculate effective lift:drag ratio from the formula:

$$
  \bigg( \frac{L}{D}\bigg)' = \frac{D}{k^{0.5}R} \bigg( \frac{S_d}{A}\bigg)^{0.5}
$$

This method corrects for change in effective lift:drag ratio during flight by increasing the lift:drag ratio by $10 \times F$ expressed as a percentage.


Finally, the range (in meters) is estimated using:

$$
  Y = \frac{e \eta}{g} \bigg( \frac{L}{D}\bigg)' ln \frac{1}{1 - F}
$$

In addition, the minimum power speed and the maximum range speed, are calculated and returned as output. The idea of including these, is for the construction of the power curve.
However, the minimum power speed is estimated numerically other than analytically. This gives a better estimate.

$$
  Vmr = \frac{k^{1/4} m ^{1/2}g^{1/2}}{\rho^{1/2} A^{1/4}S_d^{1/4}}
$$
## Outline method 2 based on Brequet equations.

Method is only appropriate for __non-passerines__ and or birds with 
$body mass > 50 \ g$ , lift:drag ratio is calculated at the beginning and at the
end of the flight. Lift:drag ratio at the start of flight is calculated using 
the all-up mass at start, while at end of flight the mass of fuel to be used 
during the flight it is subtracted from the all up mass. In the function, user 
can specify percentage of fuel mass to be used during mass. This method, uses 
the constants defined in method 1. 

*Step 1*
Fat fraction is computed as before (as a ratio of fat mass and all-up body mass). 

*Step 2*
An estimate of the body mass at end of flight is attained by subtracting fuel 
mass to be consumed during flight from the all-up body mass.

*Step 3*
Calculate *metabolic power ratio* but this time using body mass at end of flight.

$$
X2_{end} = \frac{6.03 \ \alpha \ \eta \ \rho^{0.5} \ b^{3/2} M_2 ^{\delta - 5/3}}{k^{3/4}g^{5/3}} \\
\\
\text{where } M_2 = \ \text{body mass at end of flight}    
$$

*Profile power constant* calculation remains the same as in method 1.

$$
X1  = \frac{profile \ power \ constant}{Aspect \ ratio}
$$

*Step 4*
To find drag at end of flight, metabolic power ratio and the profile power constant are summed and interpolation is done on *table 2* as defined in Pennycuick.

*Step 5*
Disk area and flat plate area are components that contribute to lift. While disk area is independent of body mass, flat-plate area is not. Therefore, flat-plate area is computed using body mass at end of flight.

$$
  S_d = \frac{\pi B^2}{4}
$$

$$
A_{end} = S_bC_{Db} \\
  S_b = 0.00813 \times \ m_2^{0.666} \\
  C_{Db} = 0.1
$$

Where $m_2$ is body mass at end of flight.

*Step 6*
Proceed to calculate effective lift:drag ratio at end of flight.

$$
\bigg( \frac{L}{D}\bigg)'_{end} = \frac{D_{end}}{k^{0.5}R} \bigg( \frac{S_d}{A_{end}}\bigg)^{0.5}
$$

*Step 7*
To avoid repetition, Pennycuick demonstrates how to estimate metabolic power constant at start by dividing the estimate at end of flight by some factor.

$$
X2_{start} = \frac{X2_{end}}{\bigg(\frac{1}{1 - F}\bigg)^{7/4}}
$$

Followed by interpolation on *table 2* to get drag at start of flight.

*Step 8*
Get square root of ratio between disk area and flat-plate area at beginning of flight as:

$$
\bigg(\frac{S_d}{A}\bigg)^{0.5}_{start} = \frac{\bigg(\frac{S_d}{A}\bigg)^{0.5}_{end}}{\bigg(\frac{M_1}{M_2} \bigg)^{0.5}}
$$


Where $M_1$ and $M_2$ are all-up mass at beginning and body mass at end of 
flight respectively.


*Step 9*
Calculate lift:drag ratio using the start of flight estimates then get the 
average of the two lift:drag ratio.

*Step 10*
Get range using the mean of the lift:drag ratio.

$$
 Y = \frac{e \eta}{g} \bigg( \frac{L}{D}\bigg)'_{avg} ln \frac{1}{1 - F}
$$

## Comparison of results with Flight.
Data used as an example, is from the program _Flight_ version 1.2.5.2 with 
default constants. In some cases, the fat mass was set to zero as defualt, and 
therefore uniformly random percentages (between 18 and 35) of all the all-up mass
(which in this case is the _Empty.mass_ because crop is empty).

```{r data, echo = FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
data("birds")
knitr::kable(birds, caption = "Preset birds from Flight program")
```

In the simulation in Flight program, air density was set to 1 (Altitude 2063 
metres above sea-level), muscle was held constant (Protein burn criterion), 
fat energy at $4.0E+07$, continous flapping style (Flight style), and minimum
energy from protein at 10%. Induced power factor was set to 1.20 for all birds.
Flight provides two methods of speed control, maximum range to minimum power 
speed is held constant, and speed is held constant. Both of these scenarios are 
compared to the output of this package below:

```{r sim, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

small_passerinesID <- which(birds$Order == 1 & birds$Empty.mass <= 0.05)

small_passerines <- birds[small_passerinesID, ]

sim1 <- flying::flysim(data = small_passerines, method = "breguet")

range_sim1 <- sim1$Range

# other birds (non-passerines or body mass > 50)
other_birds <- birds[-small_passerinesID, ]
sim2 <- flying::flysim(data = other_birds, method = "breguet_adj")

range_sim2 <- sim2$Range

mps_sim1<- sim1$Vmp

mps_sim2 <- sim2$Vmp
```

```{r sp, echo=FALSE, results='asis'}
# simulated from flight
std_option_10 <- c(1440, 4097, 3254, 2552, 3437, 3155)

v_vmp_cons_10 <- c(1354, 3723, 2960, 2372, 3122, 2862)

flight <- cbind("constant speed" = std_option_10, "V:Vmp constant" = v_vmp_cons_10)

comparison <- as.data.frame(cbind(range_sim1, "Flight" = flight))

sp <- knitr::kable(comparison, caption = "Small Passerines range comparison (10% protein)")
kableExtra::add_footnote(sp, 
             c("Flight.constant speed = hold speed constant",
             "Flight.V:Vmp constant = Hold ratio V:Vmp constant.",
             "Minimum 10% of protein is used as fuel"),
             notation = "none")
```

```{r sp2, echo=FALSE, results='asis'}
# 5% minimum protein
std_option_5 <- c(1272, 3453, 2696, 2184, 2853, 2639)

v_vmp_cons_5 <- c(1215, 3228, 2520, 2072, 2666, 2463)

flight <- cbind("constant speed" = std_option_5, "V:Vmp constant" = v_vmp_cons_5)

comparison <- as.data.frame(cbind(range_sim1, "Flight" = flight))

sp <- knitr::kable(comparison, caption = "Small Passerines range comparison (5% protein)")
kableExtra::add_footnote(sp, 
             c("Flight.constant speed = hold speed constant",
             "Flight.V:Vmp constant = Hold ratio V:Vmp constant.",
             "Minimum 5% of protein is used as fuel"),
             notation = "none")

```


```{r oth1, echo = FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# simulated from flight non-passerines or mass greater than 50 grams
std_option_10 <- c(4215, 3553, 5078, 4660, 4678, NA, 4883, 4105, 2668, 8724, 
                   18658)

v_vmp_cons_10 <- c(4003, 3337, 4774, 4382, 4452, NA, 4554, 3933, 2531, 8004,
                   17211)

flight <- cbind("constant speed" = std_option_10, "V:Vmp constant" = v_vmp_cons_10)

comparison <- as.data.frame(cbind(range_sim2, "Flight" = flight))

sp <- knitr::kable(comparison, caption = "Other birds, range comparison (10% protein)")
kableExtra::add_footnote(sp, 
             c("Birds with bodymass > 50 grams (both passerines and non-passerines)",
               "Flight.constant speed = hold speed constant",
             "Flight.V:Vmp constant = Hold ratio V:Vmp constant.",
             "Minimum 10% of protein is used as fuel"),
             notation = "none")
```

```{r oth2, echo = FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

std_option_10 <- c(3615, 3089, 4331, 3969, 4061, 17015, 4056, 3575, 2337, 6603, 
                   14384)

v_vmp_cons_10 <- c(3480, 2952, 4136, 3792, 3911, 15487, 3851, 3459, 2247, 6176,
                   1352)

flight <- cbind("constant speed" = std_option_10, "V:Vmp constant" = v_vmp_cons_10)

comparison <- as.data.frame(cbind(range_sim2, "Flight" = flight))

sp <- knitr::kable(comparison, caption = "Other birds, range comparison (5% protein)")
kableExtra::add_footnote(sp, 
             c("Birds with bodymass > 50 grams (both passerines and non-passerines)",
               "Flight.constant speed = hold speed constant",
             "Flight.V:Vmp constant = Hold ratio V:Vmp constant.",
             "Minimum 5% of protein is used as fuel"),
             notation = "none")
```



## Time-marching computation
Breguet equations assume that lift:drag ratio remains constant through out the flight. This is appropriate for fixed wing aircraft. However, birds are known to consume part of the engine (use protein in flight muscles and air-frame as supplementary fuel). This leads to an increase in lift:drag ratio during the flight as result of the reduce in body mass and thus, an increase in flight range
[@penny03]. In the methods discussed above, compensation for this is done by adding 10% of fuel to the lift:drag ratio (method 1) or averaging lift:drag ratio before start of flight and at the end of flight (method 2). @penny03 cites studies which found that protein is replenished faster during short stop-overs compared to fat mass. Furthermore, the constant ($e$) cannot be assumed to be constant because of two different sources of fuel. Protein and fat have different energy content.

@penny03 describes time-marching as calculating amounts of fat and protein consumed during a short period (6 minutes) during which all variables including power and speed are assumed constant. After every 6 minute interval, the birds mass composition is revised taking into account the small changes in fat and protein consumed during the interval. This is repeated until the bird covers the 
required distance or it runs out of fat mass. This procedure places no restriction
on speed. @penny03 points out that the remaining fat and mass at the end of the flight can be compared with field observations. 

### Protein withdrawal criterion.
@penny03 find that holding specific work constant is most realistic criteria for
determining how  much fuel and protein to be withdrawn during 6 minute intervals
of flight. Specific work is defined in as work done by unit mass of contractile
tissue muscle. Further, @penny03, states that flight muscles contain myofibrils 
and mitochondria, which are treated separately in the simulation. To be exact enough
mass of myofibrils is reduced by an amount sufficient to restore specific work
to the value it had at beginning of flight. In addition, fuel energy corresponding
to mass of dry protein consumed is deducted from energy that would otherwise
come from fuel/fat consumption.

 




Also, initial climb, and all other flight styles other than continuous wing flapping are not accounted for. 

# References

